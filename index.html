<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>E Collision – Job Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#111827" />

  <!-- VIN Barcode Scanner -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

  <style>
    body { font-family: system-ui; background:#f3f4f6; margin:0; }
    header { background:#111827; color:white; padding:12px; }
    h1 { font-size:18px; margin:0; }
    .container { max-width:900px; margin:auto; padding:12px; }
    .card { background:white; padding:12px; border-radius:10px; box-shadow:0 2px 4px rgba(0,0,0,.1); margin-bottom:12px; }
    label { font-size:12px; color:#555; display:block; margin-top:6px; }
    input, select, textarea { width:100%; padding:7px; border-radius:6px; border:1px solid #ccc; }
    textarea { min-height:60px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .col { flex:1; min-width:140px; }
    button { border:none; padding:8px 14px; border-radius:999px; cursor:pointer; }
    .btn-primary { background:#111827; color:white; }
    .btn-secondary { background:#e5e7eb; }
    .btn-danger { background:#b91c1c; color:white; }
    .hint { font-size:12px; color:#555; margin-top:6px; }

    /* VIN Scanner Overlay */
    #vinScannerOverlay {
      position:fixed; inset:0; background:rgba(0,0,0,.85);
      display:none; z-index:100; align-items:center; justify-content:center;
      flex-direction:column; color:white;
    }
    #vinScanner { width:90%; max-width:480px; border:2px solid #fbbf24; border-radius:8px; }
  </style>
</head>

<body>
<header>
  <h1>E Collision – Job Tracker</h1>
</header>

<div class="container">

  <!-- JOB FORM -->
  <div class="card">
    <h2>New / Edit Job</h2>

    <label>VIN</label>
    <input id="job_vin" placeholder="Scan or type VIN">

    <div class="row">
      <div class="col">
        <label>Year</label>
        <input id="job_year">
      </div>
      <div class="col">
        <label>Make</label>
        <input id="job_make">
      </div>
      <div class="col">
        <label>Model</label>
        <input id="job_model">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Customer</label>
        <input id="job_customer">
      </div>
      <div class="col">
        <label>Assigned Tech</label>
        <input id="job_assigned">
      </div>
    </div>

    <label>Work Type</label>
    <input id="job_work_type" placeholder="Body / Paint / Blend">

    <label>Notes</label>
    <textarea id="job_notes"></textarea>

    <div class="row" style="margin-top:10px;">
      <button class="btn-primary" onclick="saveJob()">Save Job</button>
      <button class="btn-secondary" onclick="startVinScanner()">Scan VIN (Camera)</button>
      <button class="btn-secondary" onclick="decodeVinFromInput()">Decode VIN (Manual)</button>
    </div>

    <div class="hint" id="jobsHint">
      Scan VIN from door sticker barcode. If scan fails, type VIN and tap “Decode VIN (Manual)”.
    </div>
  </div>
</div>

<!-- VIN SCANNER OVERLAY -->
<div id="vinScannerOverlay">
  <div id="vinScanner"></div>
  <p>Align VIN barcode in the box</p>
  <button class="btn-secondary" onclick="stopVinScanner()">Cancel</button>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://xmbochwqaeakijotbcof.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhtYm9jaHdxYWVha2lqb3RiY29mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjI5MTIsImV4cCI6MjA4NDU5ODkxMn0.YoxRzHEDrM9pDNEOL7mLaJewzcGB3jbZ-rc4IkR1hmQ";
const JOBS_TABLE = "jobs";

/* =============== HELPERS ================= */
async function supabaseFetch(url, options={}) {
  options.headers = {
    "apikey": SUPABASE_KEY,
    "Authorization": "Bearer " + SUPABASE_KEY,
    "Content-Type": "application/json"
  };
  const res = await fetch(url, options);
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

/* =============== SAVE JOB ================= */
async function saveJob() {
  const job = {
    vin: job_vin.value.trim(),
    year: job_year.value,
    make: job_make.value,
    model: job_model.value,
    customer: job_customer.value,
    assigned: job_assigned.value,
    work_type: job_work_type.value,
    notes: job_notes.value,
    updated_at: new Date().toISOString()
  };

  if (!job.vin) return alert("VIN required");

  await supabaseFetch(`${SUPABASE_URL}/rest/v1/${JOBS_TABLE}`, {
    method: "POST",
    body: JSON.stringify(job)
  });

  jobsHint.textContent = "Job saved ✔";
}

/* ============ VIN DECODE (API) ============ */
async function decodeVinAndFill(vin) {
  jobsHint.textContent = "Decoding VIN...";
  const res = await fetch("/.netlify/functions/decode-vin", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ vin })
  });
  const data = await res.json();

  job_year.value = data.year || "";
  job_make.value = data.make || "";
  job_model.value = data.model || "";

  jobsHint.textContent = "VIN decoded ✔";
}

function decodeVinFromInput() {
  const vin = job_vin.value.trim();
  if (!vin) return alert("Enter VIN first");
  decodeVinAndFill(vin);
}

/* ============ VIN CAMERA SCAN ============= */
let vinScannerRunning = false;

function startVinScanner() {
  vinScannerOverlay.style.display = "flex";
  if (vinScannerRunning) return;
  vinScannerRunning = true;

  Quagga.init({
    inputStream: {
      type: "LiveStream",
      target: vinScanner,
      constraints: { facingMode: "environment" },
      area: { top:"25%", right:"10%", left:"10%", bottom:"25%" }
    },
    decoder: {
      readers: [
        "code_39_vin_reader",
        "code_39_reader",
        "code_128_reader"
      ]
    },
    locate:true,
    numOfWorkers:0
  }, err => {
    if (err) {
      alert("Camera error");
      stopVinScanner();
      return;
    }
    Quagga.start();
  });

  Quagga.onDetected(data => {
    const raw = data.codeResult.code;
    const vin = raw.replace(/[^A-Z0-9]/gi,"").toUpperCase();
    if (vin.length === 17) {
      stopVinScanner();
      job_vin.value = vin;
      decodeVinAndFill(vin);
    }
  });
}

function stopVinScanner() {
  vinScannerOverlay.style.display = "none";
  try { Quagga.stop(); } catch(e){}
  Quagga.offDetected();
  vinScannerRunning = false;
}
</script>
</body>
</html>